---
title: 服务器加固
date: 2019-3-11 21:43:52
tags:
    - Linux
    - 加固
    - mysql
categories: [学习笔记]
---


## linux加固

### 一、系统默认账号及组管理

>删除系统默认不使用的帐号，包括：lp、mail、games、ftp、nobody、postfix等。删除系统默认不使用的组，包括：mail、games、ftp、nobody、postfix等。

<!-- more -->

### 二、启用密码策略

1. 密码60天过期，修改密码最小间隔为1天，最短密码要求8，密码过期前7天通知用户。

修改 `/etc/login.defs`来实现

```
PASS_MAX_DAYS   60
PASS_MIN_DAYS   1
PASS_MIN_LEN    8
PASS_WARN_AGE   7
```

2. 连续3次输入密码错误，锁定5分钟，主要防止爆破

修改`/etc/pam.d/system-auth`文件

```
auth required pam_env.so

auth required pam_tally2.so deny=3 unlock_time=300
```
### 三、SSH安全配置

1. 禁止root登录，禁止空口零登录

修改配置文件 `/etc/ssh/sshd_config`

>ssh  v1存在缺陷，不能使用这个版本的，应该使用SSH V2

```
Protocol 2         #只使用协议版本2
PermitRootLogin no #禁止root登录
PermitEmptyPasswords no #禁止空口令登录
```

新建一个用户 useradd `testuser` ,设置密码 passwd `testpass` 密码8位以上，使用testuser 登录服务器，在 su到root用户。

重启服务
`service sshd restart`

2. 长时间无人操作自动断开ssh连接

修改配置文件`/etc/profile` 在末尾加上

```
TMOUT=300    # 单位是秒
```

### 四、禁用所有特殊账户

应该从系统中删除所有默认用户和组
例如 news,lp,sync,shutdown,uucp,games,halt 等
方法：
删除账户 `userdel name`
删除组 `groupdel name`


### 五、检测监听的端口

检测是否有必要开放端口是非常重要的
方法：
`netstat -tulp`

## Apache 加固

### 禁止Apache访问Web目录之外的任何文件

编辑 httpd.conf配置文件，修改为：
```
<Directory />
Order Deny,Allow
Deny from all
</Directory>
```
如果apache必须要访问web目录以外的目录或文件，可以设置可访问目录，
```
<Directory /web>
Order Allow,Deny
Allow from all
</Directory>
```
其中/web为网站根目录。

### 防止apache列目录

(1) 编辑httpd.conf配置文件
```
<Directory "/web">
Options FollowSymLinks
AllowOverride None
Order allow,deny
Allow from all
</Directory>
```

将Options Indexes FollowSymLinks中的Indexes去掉，就可以禁止Apache显示该目录结构。Indexes的作用就是当该目录下没有index.html文件时，就显示目录结构。

(2)设置 Apache 的默认页面，编辑%apache%\conf\httpd.conf配置文件

```
<IfModule dir_module>
        DirectoryIndex index.html
</IfModule>
```

其中index.html即为默认页面，可根据情况改为其它文件。

(3)重新启动 Apache 服务

## Mysql

### MYSQL权限详细分类

全局管理权限：

FILE: 在MySQL服务器上读写文件。

PROCESS: 显示或杀死属于其它用户的服务线程。

RELOAD: 重载访问控制表，刷新日志等。

SHUTDOWN: 关闭MySQL服务。

数据库/数据表/数据列权限：

ALTER: 修改已存在的数据表(例如增加/删除列)和索引。

CREATE: 建立新的数据库或数据表。

DELETE: 删除表的记录。

DROP: 删除数据表或数据库。

INDEX: 建立或删除索引。

INSERT: 增加表的记录。

SELECT: 显示/搜索表的记录。

UPDATE: 修改表中已存在的记录。

特别的权限：

ALL: 允许做任何事(和root一样)。

USAGE: 只允许登录--其它什么也不允许做。



### 权限控制

| 账户 |          权限          |     登录      |
| ---- | ---------------------- | ------------- |
| root | 禁用file权限            | 仅限localhost |
| user | 禁用file权限，禁止新建库 | 仅限localhost |

### 账户安全

权限需求：

select, insert, update, delete, alter, create, index

### 用户授权方法

创建用户并仅限本地登录：

```
CREATE USER 'senna'@'localhost' IDENTIFIED BY '123456';
```
>如果要允许远程登录，则将上述语句中的localhost改为%

比如设置mysql账户senna对数据库user有select，insert，update，delete权限，但没有drop权限，则执行SQL语句：

```
GRANT select，insert，update，delete ON USER TO senna@"localhost";
```

如果要赋予某用户对某库的所有控制权，则语句为：

```
GRANT ALL PRIVILEGES ON USER TO senna@"localhost";
```

最后重载授权表：
FLUSH PRIVILEGES;

可以适用GRANT语句直接新建mysql账户并完成指定数据库的授权，比如创建一个senna用户，密码为123456，并且只能对user数据库进行操作：

```
GRANT ALL ONuser.* TO senna IDENTIFIED BY "123456";
```

### 禁止远程登录

限制所有的mysql账户都只能在localhost登录，禁止远程登录。

```
update mysql.user set HOST='localhost'
```

### 禁用file权限

禁用所有mysql账户的file权限。

以root权限登录数据库，执行SQL：

```
UPDATE mysql.user SET File_priv = 'N';
```

如果要禁止单个用户的file权限，在上述语句中跟上where子句即可：

UPDATE mysql.user SET File_priv = 'N'; WHERE USER='root'

只有root可以新建/删除库，禁用其他mysql账户新建/删除库的权限。

禁止将process或super权限赋给非管理员用户。

### 修改默认mysql管理员帐号

系统mysql的管理员名称是root，一般情况下都没进行修改

执行：

update user set user="fds654dtasd" where user="root";

flush privileges;

**暂时就这些吧，还有好多如nginx、php等还未更新。。。**