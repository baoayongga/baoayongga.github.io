---
title: Web应用程序渗透测试思路
date: 2019-2-24 13:31:13
tags:
    - Linux
    - 规范
categories: [读书分享]
---

## 一般规范

**一些字符在HTTP请求的不同位置具有不同含义。当修改请求中的数据时，应该对这些字符进行URL编码，以确保应用程序按照想要的方式解释这些字符。**

<!-- more -->

>&用分割URL查询字符串与消息主体中的参数，要插入字面量&字符，必须将其转换成URL编码 **%26**。

>=用于分割URL查询字符串与消息主体中每个参数的名称与值，所以要插入字面量=字符时要URL编码**%3d**。

>?用于标记URL查询字符串的起始位置。要插入字面量需要URL编码**%3f**。

>空格用于在请求的第一行中标记URL的结束位置，并可用于Cookie消息头中表示一个cookie值结束。要插入一个字面两空格字符必须将其转换成**%20**或+。

>因为+表示一个编码的空格，要插入一个字面量+字符，需编码为**%2b**。


>；用于在Cookie消息头中分隔单个Cookie。要插入字面量+字符，必须将其编码为%3b。

>#用于在URL中标记片段标识符。如果在浏览器的URL中输入这个字符，他将会传送给服务器的URL截短。要插入需将其编码为%23。

>%在URL编码方案中作为前缀。要插入字面量%字符，必须将其编码为%25。

```
此外要注意的是，在表单中输入URL编码的数据通常会导致浏览器执行另一层编码。例如在表单中提交%00可能会导致想服务器发送值%2500。为此，通常最好是在拦截代理服务器中查看最终请求。
```
```
许多查找常见Web应用程序的测试需要发送各种专门设计的输入字符串，并监控应用程序的响应，从中搜索表示漏洞存在的反常现象。有时，无论是否提交某个特定漏洞的触发器，应用程序对一个特殊请求的响应都将包含这个漏洞的签名。只要提交专门设计的特殊输入导致了与某个漏洞有关的行为（如一个特殊的错误消息），就应该重新核查，确定在相关参数中提交良性输入是否也会造成相同的行为。如果两种输入的行为相同，那么最初的发现可能是一个错误警报。
```

## 解析应用程序内容

### 搜索可见的

1. 配置浏览器，使用首先集成代理/抓取工具。可以使用Burp监控和解析有代理服务器处理的Web内容。

2. 配置浏览器，监控和分析被浏览器处理的HTTP和HTML内容。

3. 以常规的方法应用程序，访问发现的每个链接URL,提交每一个表单并执行全部多阶段功能。尝试激活与禁用JS,激活与禁用Cookie的情况下浏览。

4. 如果应用程序使用身份验证，并且渗透测试人员拥有帐号，或可以注册帐号，那么就可以使用该帐号访问受保护的内容。

5. 当浏览，监控通过拦截代理服务器的请求与响应时，了解被提交的数据种类，了解客户端是如何控制服务器端的应用程序的行为。

6. 检查被动抓取生成的站点地图，确定任何尚未使用浏览器访问到的内容或功能。

7. 完成手动浏览和被动抓取后，可以用一组发现的URL作为种子，使用爬虫抓取应用程序。有时候可以发现手动浏览时尚未发现的内容。

### 浏览公共资源

1. 使用因特网搜索引擎和历史档案。

2. 使用高级搜索语法提高搜索效率。

3. 搜索在应用程序内容中发现的任何姓名和电子邮箱地址等。包括新闻和分组搜索等。

4. 检查任意已发布的WSDL文件（ WebServices Description Language (WSDL Web服务语言)是一个用于精确描述Web Service的文档格式。），以生成应用程序可能采用的功能名称和参数值列表。

### 发现隐藏的内容
1. 确定应用程序如何处理访问不存在的资源的请求。手动提交一些请求，访问已知有效和无效的资源，比较对这些请求的响应。找到一种确定资源并不存在的方法。

2. 获取常见文件与目录名以及常见的文件扩展名列表。根据这些内容设法推断出其他内容，假如有a.php，c.php 那可以推断出有c.php。

3. 审查所有客户端代码，确定任何与服务器端内容（包括HTML注释和禁用的表单元素）有关线索。

4. 使用自动化技巧，根据目录名，文件名，文件扩展名列表提出大量请求，监控应用程序的相应。

### 查找默认的内容

1. 探查所有默认或已知存在的内容，使用NIKTO的选项提高探查的效率。

2. 手动核查所有可能有用的发现，减少探查结果中的错误警报。

### 枚举标识符指定的功能

确定任何通过在请求参数中提交一个功能标识符访问特殊应用程序功能的情况。（如 admin.jsp/login.php）

### 调试参数

1. 选择一个或几个使用隐藏调试参数（如debug=true）的应用程序或页面或功能，他们最有可能出现在，登录，搜索，文件上传下载等功能上。

2. 使用常用调试参数名（debug、test、hide、source）与常用参数值（true、yes、on、1）列表，排出键值对组合，可使用Burp。

3. 在应用程序的响应中查找任何表示添加的参数对应用程序的行为造成影响的反常现象。

##  分析应用程序
### 确定功能
1. 确定为使应用程序正常运行而建立的核心功能以及每项功能旨在执行的操作。

2. 确定应用程序采用的核心安全机制以及他们的工作机制。如了解处理身份验证、会话管理、与访问控制的关键机制以及支持他们的功能、如用户注册和账户恢复。

3. 确定所有外围功能和行为，如重定向，站外链接，错误消息，管理与日志功能。

### 确定数据进入点

1. 确定在应用程序中引入用户输入的所有进入点，URL、查询字符串参数、POST数据、cookie与其他应用程序处理的HTTP消息头。

2. 分析应用程序使用的所有定制数据传输或编码机制，如非常规的查询字符串格式。

3. 去定所有应用程序中引入用户控制或其他第三方数据的外带通道，如处理显示SMTP收到的消息的Web邮件应用。

### 确定所使用的技术

1. 确定，如果表单、脚本、Cookie、控件等不同技术。

2. 尽可能确定服务器端使用的技术，包括脚本语言、应用程序平台、数据库、邮件系统等。

3. 网站指纹识别。

### 解析受攻击面

1. 设法去定服务器端应用程序的内部结果与功能以及用于实现客户端可见行为的后台机制。

2. 确定各种与每一项功能有关的常见漏洞。

3. 定制攻击计划，优先考虑最有用的功能以及与它有关的最严重的潜在漏洞。

## 测试客户端控件

### 通过客户端传送数据

1. 在应用程序中，确定隐藏的表单字段、cookie和URL参数明显用于通过客户端传送数据的所有情况。

2. 检查逻辑错误

## 测试验证机制

![](_v_images/20190104162829209_242673519.png)


### 了解验证机制

1. 确定应用程序使用的验证技术。

2. 确定所有与验证有关的功能。

3. 如果应用程序为采用自动自我注册机制，确定是否可以使用任何其他地方获得几个用户账户。

### 测试密码强度

1. 在应用程序中查找有关用户密码最小强度规则的说明。

2. 尝试使用所有自我注册或密码修改功能，设定各种脆弱密码，确定应用程序实际应用的密码强度尝试。

3. 测试不完整的证书确认。

4. 爆破。

### 测试用户名枚举

可使用Burp批量跑，然后查看返回的结果对比不同。

### 测试密码猜测的适应性

使用有效用户名和无效用户的请求。监控应用程序的响应，确定他们之间的所有差异。如果测试多次失败还没返回任何锁定账户的消息，再提交一个正确的包含有效证书的请求。如果这个请求成功，那说明应用程序没采用任何账户锁定策略。

这个时候就可以批量跑爆破了。

### 测试账户恢复功能

1. 查看是否有忘记密码功能

2. 使用一个帐号完成账户恢复的功能，了解运作机制。

3. 查看是否有密保机制，并且尝试找出容易猜测出答案的问题。

4. 查看是否有暗示功能。如果有尝试上面。

5. 是否为发送邮件完成帐号恢复，确定是否控制邮件。

### 测试“记住我”功能

1. 如果有记住我功能，激活并分析他的作用，并且仔细查找可能存在的漏洞。

2. 检查记住我功能设定的所有持久性cookie。寻找任何明确表示出用户身份或明显包含可预测的用户标识符的数据。

3. 即使其中保存的数据经过严密编码或模糊处理，也要仔细分析这些数据，并比较“记住”几个非常类似的用户名和密码的结果，找到逆向的机会。

4. 根据上面的结果，适当修改cookie，尝试登录。

### 测试伪装功能
1. 如果应用包含任何明确的功能，允许伪装成另一名用户，那么仔细审查，查找是否越权漏洞存在。

2. 尝试伪装成管理。

### 尝试用户名唯一性
1. 尝试用不同的密码注册相同的账户

2. 如果被阻止，就可以枚举出注册用户名

3. 如果可以注册多个相同账户，分析这个情况，尝试修改一个用户名的密码，使其与另外一个相同，然后登录。

### 测试证书的可预测性

1. 如果用户名或密码有应用程序自动生成，设法获得几个相连的用户名或密码。确定任何可探测顺序或模式。

2. 如果生成的用户名可预测，那么就可以推断出有效的用户名。

### 检测不安全的证书传输

1. 遍历所有需要传输证书，与验证有关的功能，登录、注册、密码修改等等。拦截查看所有流量。

2. 查看是否加密传输。

3. 查看证书是否保存在cookie中，有可能导致XSS攻击

4. 是否为HTTPS加载登录表单，如果不是，那么可能会遭受到中间人攻击。

### 测试不安全的证书分配
1. 确定应用程序如何想新用户分配证书。常用的方法如电子邮件等。

2. 如果应用程序分配账户激活URL，尝试注册几个紧密相连的新账户，并确定收到的URL中的顺序。如果有规律，尝试预测后续或最近的用户的URL，尝试占有他们的账户。

3. 尝试多次重复使用同一个URL，看看应用程序是允许这么做。确定这种方式是否可以给一个已经激活的账户设定一个新密码。

### 测试不安全的存储

1. 如果可以访问散列密码，应检查共享同一个散列密码值的账户。尝试以采用最常用的散列值的密码登录。

2. 使用相关散列算法或彩虹表查找明文值。

### 测试逻辑缺陷
#### 1.测试故障开放条件
1. 对于要求应用程序检查用户证书的每一项功能（包括登录与密码修改功能），使用受控制的账户以正常方式访问这些功能。注意它们提交给应用程序的每一项请求参数。

2. 连续多次重复以上过程，以各种无法预料的方式轮流修改每一项参数，破坏应用程序的逻辑，对每一个参数进行以下修改。
> 提交一个空字符串值。
>
> 完全删除名/值对。
>
> 提交非常长和非常短的值。
>
> 提交字符串代替数字或提交数字代替字符串。
>
> 以相同和不同的值，多次提交同一个命名参数。

3. 检查上述的请求的响应，如果出现任何无法预料的差异，对这个结果进行进一步测试。

#### 2.测试多阶段处理机制

1. 如果任何与验证有关的功能需要在一系列不同的请求中提交证书，确定每个阶段的主要目的，同时注意每个阶段提交的参数。

2. 多次重复上述步骤，修改提交请求的顺序，破坏应用程序的逻辑。相关测试包括：
>以不同顺序完成所有阶段，到达想要的那个阶段。
>
>轮流直接进入每一个阶段，然后按正常顺序访问后续步骤。
>
>几次访问上述功能，轮流省略每一个阶段，然后在后一个阶段继续按正常的顺序访问。
>
>根据观察到的结果及每个功能阶段的主要目的，尝试通过其他方式修改访问这些阶段的顺序，并访问开发者没有预料到的阶段。

3. 做开发者没想到的事。

### 利用漏洞获取为授权访问

1. 尝试以另一名用户的身份进行验证，最好是管理员
2. 爆破时要考虑密码强度规则以及密码确认机制的完整性，避免浪费。
3. 可使用Burp搞定。

#### 未完待续

来自 《黑客攻防技术宝典-Web实战篇(The Web Application Hacker's Handbook Version2)》